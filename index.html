<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA_OT62IGPCaueoFN7yQP1EmeR1Yem4FW8",
    authDomain: "collabcloud-f0ed5.firebaseapp.com",
    databaseURL: "https://collabcloud-f0ed5-default-rtdb.firebaseio.com",
    projectId: "collabcloud-f0ed5",
    storageBucket: "collabcloud-f0ed5.appspot.com",
    messagingSenderId: "490023921099",
    appId: "1:490023921099:web:your-app-id"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const usernameSpan = document.getElementById("displayUsername");
  const usernameEditor = document.getElementById("usernameEditor");

  usernameSpan.onclick = () => {
    usernameSpan.style.display = "none";
    usernameEditor.style.display = "inline";
    usernameEditor.value = localStorage.getItem("username") || "Anonymous";
    usernameEditor.focus();
  };
  usernameEditor.onblur = () => {
    localStorage.setItem("username", usernameEditor.value.trim() || "Anonymous");
    usernameSpan.textContent = localStorage.getItem("username");
    usernameEditor.style.display = "none";
    usernameSpan.style.display = "inline";
  };
  usernameSpan.textContent = localStorage.getItem("username") || "Anonymous";

  document.getElementById("filePic").addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        document.getElementById("profilePic").src = reader.result;
      };
      reader.readAsDataURL(file);
    }
  });

  function sendMessage(parentId = null) {
    const topic = document.getElementById("topicInput").value.trim();
    const text = document.getElementById("msgInput").value.trim();
    const file = document.getElementById("fileMedia").files[0];
    const username = localStorage.getItem("username") || "Anonymous";

    if (!text && !file) return;

    const post = {
      topic: topic || "General",
      text,
      username,
      timestamp: Date.now(),
      media: null,
      type: null,
      parentId
    };

    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        post.media = reader.result;
        post.type = file.type.startsWith("image") ? "image" : "video";
        db.ref("posts").push(post);
        clearForm();
      };
      reader.readAsDataURL(file);
    } else {
      db.ref("posts").push(post);
      clearForm();
    }
  }

  function clearForm() {
    document.getElementById("msgInput").value = "";
    document.getElementById("fileMedia").value = "";
    document.getElementById("topicInput").value = "";
  }

  function createPostElement(id, data) {
    const container = document.createElement("div");
    container.className = "message";
    container.innerHTML = `
      <div class="topic-title">${data.topic}</div>
      <p>${data.text}</p>
      ${data.media ? (data.type === "image" ?
        `<img class="attached" src="${data.media}">` :
        `<video class="attached" controls src="${data.media}"></video>`) : ""}
      <small>Posted by <b>${data.username}</b></small>
      <div class="actions">
        ${data.username === localStorage.getItem("username") ? `
          <button onclick="editMessage('${id}', '${data.text.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
          <button onclick="deleteMessage('${id}')">üóëÔ∏è</button>` : ""}
        <button onclick="showReplyBox('${id}')">üí¨</button>
      </div>
      <div id="replies-${id}" class="reply-box"></div>
    `;
    return container;
  }

  function editMessage(id, oldText) {
    const newText = prompt("Edit your message:", oldText);
    if (newText !== null) {
      db.ref("posts/" + id).update({ text: newText });
    }
  }

  function deleteMessage(id) {
    if (confirm("Delete this post?")) {
      db.ref("posts/" + id).remove();
    }
  }

  function showReplyBox(parentId) {
    const container = document.getElementById("replies-" + parentId);
    container.innerHTML = `
      <textarea placeholder="Reply..." id="replyInput-${parentId}"></textarea>
      <button onclick="sendReply('${parentId}')">Reply</button>
    `;
  }

  function sendReply(parentId) {
    const textarea = document.getElementById("replyInput-" + parentId);
    const text = textarea.value.trim();
    if (text) {
      document.getElementById("msgInput").value = text;
      sendMessage(parentId);
    }
  }

  function renderMessages(snapshot) {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";

    const data = snapshot.val() || {};
    const parents = Object.entries(data).filter(([_, v]) => !v.parentId);
    const replies = Object.entries(data).filter(([_, v]) => v.parentId);

    for (const [id, msg] of parents.sort((a, b) => b[1].timestamp - a[1].timestamp)) {
      const postElem = createPostElement(id, msg);
      messagesDiv.appendChild(postElem);

      replies.filter(([_, r]) => r.parentId === id).forEach(([rid, rdata]) => {
        const replyElem = createPostElement(rid, rdata);
        replyElem.style.marginLeft = "20px";
        document.getElementById(`replies-${id}`).appendChild(replyElem);
      });
    }
  }

  db.ref("posts").on("value", renderMessages);
</script>
