<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CollabCloud</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    body { background: #f0f2f5; color: #000; transition: background 0.3s, color 0.3s; }
    body.dark { background: #1e1e1e; color: #fff; }
    header { display: flex; justify-content: space-between; align-items: center; background: #0078d4; padding: 10px 20px; color: #fff; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .profile-area { display: flex; align-items: center; gap: 10px; }
    .profile-area img { height: 40px; width: 40px; border-radius: 50%; cursor: pointer; object-fit: cover; }
    .dark-toggle { font-size: 20px; background: white; border-radius: 50%; padding: 8px; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
    main { margin: 20px auto; padding: 20px; max-width: 800px; background: #fff; border-radius: 10px; position: relative; }
    body.dark main { background: #333; }
    input[type="text"], textarea, button { margin-bottom: 10px; padding: 10px; border-radius: 5px; width: 100%; }
    button { background: #0078d4; color: #fff; border: none; cursor: pointer; }
    .message { background: #eef6ff; padding: 10px; border-radius: 6px; margin-top: 10px; position: relative; text-align: left; }
    body.dark .message { background: #2c2c2c; }
    .actions { position: absolute; top: 5px; right: 10px; display: flex; gap: 5px; }
    .actions button { background: transparent; color: #0078d4; border: none; cursor: pointer; }
    img.attached, video.attached { margin-top: 10px; max-width: 100%; border-radius: 5px; display: block; }
    span#displayUsername { cursor: pointer; font-weight: bold; }
    input#usernameEditor { display: none; font-size: 16px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; width: auto; }
    .topic-title { font-size: 1.2em; font-weight: bold; margin-top: 10px; }
    .emoji-picker-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: #eee; font-size: 18px; cursor: pointer; position: absolute; top: 10px; right: 10px; }
    .emoji-picker { position: absolute; z-index: 1000; top: 60px; right: 10px; background: white; border: 1px solid #ccc; border-radius: 8px; max-height: 300px; overflow-y: auto; padding: 10px; display: none; flex-wrap: wrap; width: 300px; }
    .emoji-picker span { cursor: pointer; font-size: 20px; margin: 5px; }
    .reply-box { margin-top: 10px; padding-left: 20px; }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="logo.png" alt="Logo" height="40" />
      <h1>CollabCloud</h1>
    </div>
    <div class="profile-area">
      <span id="displayUsername">Anonymous</span>
      <input type="text" id="usernameEditor" />
      <img id="profilePic" src="https://via.placeholder.com/40" onclick="document.getElementById('filePic').click()" />
      <input type="file" id="filePic" accept="image/*" style="display: none;" />
      <button class="dark-toggle" onclick="toggleDarkMode()">üåì</button>
    </div>
  </header>
  <main>
    <input type="text" id="topicInput" placeholder="Enter topic" />
    <div style="position: relative;">
      <textarea id="msgInput" placeholder="Type here..." style="padding-right: 50px;"></textarea>
      <button class="emoji-picker-btn" onclick="toggleEmojiPicker()">üòä</button>
      <div id="emojiPicker" class="emoji-picker"></div>
    </div>
    <input type="file" id="fileMedia" accept="image/*,video/*" />
    <button onclick="sendMessage()">Send</button>
    <div id="messages"></div>
  </main>

  <script>
    // Firebase setup
    const firebaseConfig = {
      apiKey: "AIzaSyA_OT62IGPCaueoFN7yQP1EmeR1Yem4FW8",
      authDomain: "collabcloud-f0ed5.firebaseapp.com",
      databaseURL: "https://collabcloud-f0ed5-default-rtdb.firebaseio.com",
      projectId: "collabcloud-f0ed5",
      storageBucket: "collabcloud-f0ed5.appspot.com",
      messagingSenderId: "490023921099",
      appId: "1:490023921099:web:dummy"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Username persistence
    const usernameSpan = document.getElementById("displayUsername");
    const usernameEditor = document.getElementById("usernameEditor");
    usernameSpan.onclick = () => {
      usernameSpan.style.display = "none";
      usernameEditor.style.display = "inline";
      usernameEditor.value = localStorage.getItem("username") || "Anonymous";
      usernameEditor.focus();
    };
    usernameEditor.onblur = () => {
      localStorage.setItem("username", usernameEditor.value.trim() || "Anonymous");
      usernameSpan.textContent = localStorage.getItem("username");
      usernameEditor.style.display = "none";
      usernameSpan.style.display = "inline";
    };
    usernameSpan.textContent = localStorage.getItem("username") || "Anonymous";

    document.getElementById("filePic").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          document.getElementById("profilePic").src = reader.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Dark mode
    function toggleDarkMode() {
      document.body.classList.toggle("dark");
      localStorage.setItem("darkMode", document.body.classList.contains("dark") ? "1" : "0");
    }
    if (localStorage.getItem("darkMode") === "1") document.body.classList.add("dark");

    // Emoji Picker
    const emojiPicker = document.getElementById("emojiPicker");
    const msgInput = document.getElementById("msgInput");
    const emojis = Array.from({ length: 80 }, (_, i) => String.fromCodePoint(0x1F600 + i));
    emojiPicker.innerHTML = emojis.map(e => `<span onclick="addEmoji('${e}')">${e}</span>`).join('');
    function toggleEmojiPicker() {
      emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
    }
    function addEmoji(emoji) {
      msgInput.value += emoji;
    }

    // Post Message
    function sendMessage(parentId = null) {
      const topic = document.getElementById("topicInput").value.trim();
      const text = msgInput.value.trim();
      const file = document.getElementById("fileMedia").files[0];
      const username = localStorage.getItem("username") || "Anonymous";

      if (!text && !file) return;

      const post = {
        topic: topic || "General",
        text,
        username,
        timestamp: Date.now(),
        media: null,
        type: null,
        parentId
      };

      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          post.media = reader.result;
          post.type = file.type.startsWith("image") ? "image" : "video";
          db.ref("posts").push(post);
          clearForm();
        };
        reader.readAsDataURL(file);
      } else {
        db.ref("posts").push(post);
        clearForm();
      }
    }

    function clearForm() {
      msgInput.value = "";
      document.getElementById("fileMedia").value = "";
      document.getElementById("topicInput").value = "";
    }

    function createPostElement(id, data) {
      const container = document.createElement("div");
      container.className = "message";
      container.innerHTML = `
        <div class="topic-title">${data.topic}</div>
        <p>${data.text}</p>
        ${data.media ? (data.type === "image"
          ? `<img class="attached" src="${data.media}">`
          : `<video class="attached" controls src="${data.media}"></video>`) : ""}
        <small>Posted by <b>${data.username}</b></small>
        <div class="actions">
          ${data.username === localStorage.getItem("username") ? `
            <button onclick="editMessage('${id}', '${data.text.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
            <button onclick="deleteMessage('${id}')">üóëÔ∏è</button>` : ""}
          <button onclick="showReplyBox('${id}')">üí¨</button>
        </div>
        <div id="replies-${id}" class="reply-box"></div>
      `;
      return container;
    }

    function editMessage(id, oldText) {
      const newText = prompt("Edit your message:", oldText);
      if (newText !== null) {
        db.ref("posts/" + id).update({ text: newText });
      }
    }

    function deleteMessage(id) {
      if (confirm("Delete this post?")) {
        db.ref("posts/" + id).remove();
      }
    }

    function showReplyBox(parentId) {
      const container = document.getElementById("replies-" + parentId);
      container.innerHTML = `
        <textarea placeholder="Reply..." id="replyInput-${parentId}"></textarea>
        <button onclick="sendReply('${parentId}')">Reply</button>
      `;
    }

    function sendReply(parentId) {
      const textarea = document.getElementById("replyInput-" + parentId);
      const text = textarea.value.trim();
      if (text) {
        msgInput.value = text;
        sendMessage(parentId);
      }
    }

    function renderMessages(snapshot) {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
      const data = snapshot.val() || {};
      const parents = Object.entries(data).filter(([_, v]) => !v.parentId);
      const replies = Object.entries(data).filter(([_, v]) => v.parentId);

      for (const [id, msg] of parents.sort((a, b) => b[1].timestamp - a[1].timestamp)) {
        const postElem = createPostElement(id, msg);
        messagesDiv.appendChild(postElem);
        replies.filter(([_, r]) => r.parentId === id).forEach(([rid, rdata]) => {
          const replyElem = createPostElement(rid, rdata);
          replyElem.style.marginLeft = "20px";
          document.getElementById(`replies-${id}`).appendChild(replyElem);
        });
      }
    }

    db.ref("posts").on("value", renderMessages);
  </script>
</body>
</html>
