<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CollabCloud</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; margin: 0; background: #f0f0f0; color: #000; transition: 0.3s; }
    body.dark { background: #121212; color: #fff; }
    header { background: #0078d4; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    main { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; }
    body.dark main { background: #1f1f1f; }
    input, textarea, button { width: 100%; margin: 5px 0; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { background: #0078d4; color: white; border: none; cursor: pointer; }
    .message { background: #e0f0ff; padding: 10px; border-radius: 6px; margin-bottom: 10px; position: relative; }
    body.dark .message { background: #2c2c2c; }
    .actions { position: absolute; top: 5px; right: 10px; }
    .actions button { background: none; border: none; color: #0078d4; cursor: pointer; padding: 0 4px; }
    .media { max-width: 100%; margin-top: 10px; border-radius: 5px; }
    .pinned { border: 2px solid gold; background: #fff8dc; }
  </style>
</head>
<body>
  <header>
    <div><strong>CollabCloud</strong></div>
    <div>
      <input id="usernameInput" placeholder="Enter your name" style="padding:5px;" />
      <button onclick="toggleDarkMode()">üåì</button>
    </div>
  </header>

  <main>
    <input id="searchBar" placeholder="Search by topic or user" />
    <input id="topicInput" placeholder="Topic (optional)" />
    <textarea id="msgInput" placeholder="Write a message..."></textarea>
    <input type="file" id="fileInput" accept="image/*,video/*" />
    <button onclick="sendMessage()">Send</button>

    <h3>Pinned Messages</h3>
    <div id="pinned"></div>
    <hr/>
    <h3>All Messages</h3>
    <div id="messages"></div>
  </main>

  <script>
    // Firebase config
    const config = {
      apiKey: "AIzaSyA_OT62IGPCaueoFN7yQP1EmeR1Yem4FW8",
      authDomain: "collabcloud-f0ed5.firebaseapp.com",
      databaseURL: "https://collabcloud-f0ed5-default-rtdb.firebaseio.com",
      projectId: "collabcloud-f0ed5",
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      localStorage.setItem('dark', document.body.classList.contains('dark') ? '1' : '0');
    }
    if (localStorage.getItem('dark') === '1') document.body.classList.add('dark');

    function getUserName() {
      const name = document.getElementById('usernameInput').value.trim();
      return name || 'Anonymous';
    }

    function sendMessage(parent = null) {
      const name = getUserName();
      const text = document.getElementById('msgInput').value.trim();
      const topic = document.getElementById('topicInput').value.trim() || 'General';
      const file = document.getElementById('fileInput').files[0];

      if (!text && !file) return;

      const post = {
        user: name,
        text: text,
        topic: topic,
        timestamp: Date.now(),
        pinned: false,
        parent: parent,
      };

      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          post.media = reader.result;
          post.type = file.type.startsWith('image') ? 'image' : 'video';
          db.ref('posts').push(post);
        };
        reader.readAsDataURL(file);
      } else {
        db.ref('posts').push(post);
      }

      document.getElementById('msgInput').value = '';
      document.getElementById('fileInput').value = '';
    }

    function loadMessages() {
      db.ref('posts').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        const all = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);
        const pinnedDiv = document.getElementById('pinned');
        const messagesDiv = document.getElementById('messages');
        const filter = document.getElementById('searchBar').value.toLowerCase();

        pinnedDiv.innerHTML = '';
        messagesDiv.innerHTML = '';

        all.forEach(([id, msg]) => {
          if (filter && !msg.topic.toLowerCase().includes(filter) && !msg.user.toLowerCase().includes(filter)) return;

          const div = document.createElement('div');
          div.className = 'message' + (msg.pinned ? ' pinned' : '');
          div.innerHTML = `
            <div><strong>${msg.topic}</strong></div>
            <div>${msg.text || ''}</div>
            ${msg.media ? (msg.type === 'image' ? `<img class="media" src="${msg.media}"/>` : `<video class="media" controls src="${msg.media}"></video>`) : ''}
            <div><small>By: ${msg.user}</small></div>
            <div class="actions">
              <button onclick="togglePin('${id}', ${!msg.pinned})">${msg.pinned ? 'Unpin' : 'Pin'}</button>
              <button onclick="edit('${id}', \`${msg.text?.replace(/`/g, '\\`') || ''}\`)">‚úèÔ∏è</button>
              <button onclick="del('${id}')">üóëÔ∏è</button>
              <button onclick="reply('${id}')">üí¨</button>
            </div>
          `;
          if (msg.pinned) pinnedDiv.appendChild(div);
          else messagesDiv.appendChild(div);
        });
      });
    }

    function togglePin(id, state) {
      db.ref('posts/' + id).update({ pinned: state });
    }

    function edit(id, oldText) {
      const newText = prompt('Edit your message:', oldText);
      if (newText !== null) db.ref('posts/' + id).update({ text: newText });
    }

    function del(id) {
      if (confirm('Are you sure you want to delete this message?')) {
        db.ref('posts/' + id).remove();
      }
    }

    function reply(parentId) {
      const response = prompt('Enter your reply:');
      if (response) {
        document.getElementById('msgInput').value = response;
        sendMessage(parentId);
      }
    }

    document.getElementById('searchBar').oninput = loadMessages;

    loadMessages();
  </script>
</body>
</html>
